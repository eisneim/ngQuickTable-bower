"use strict";var ngQT=angular.module("ngQuickTable",[]);ngQT.provider("ngQuickTableDefaults",function(){return{options:{dateFormat:"M/d/yyyy"},$get:function(){return this.options},set:function(keyOrHash,value){var k,v,_results;if("object"==typeof keyOrHash){_results=[];for(k in keyOrHash)v=keyOrHash[k],_results.push(this.options[k]=v);return _results}return this.options[keyOrHash]=value}}}),ngQT.factory("$qtUtil",[function(){var dom={};dom.findParentScrolled=function(elm){var parent=elm.parentNode;if(parent.isEqualNode(document.body))return!1;var styles=getComputedStyle(parent);return elm.scrollHeight>parent.clientHeight&&("scroll"==styles.overflow||"scroll"==styles["overflow-y"]||"auto"==styles.overflow||"auto"==styles["overflow-y"])?parent:findParentScrolled(parent)};var debounce=function(func,wait){var args,context,later,result,timeout,timestamp;return timeout=args=context=timestamp=result=null,later=function(){var last;return last=+new Date-timestamp,timeout=wait>last&&last>0?setTimeout(later,wait-last):null},function(){return context=this,args=arguments,timestamp=+new Date,timeout||(timeout=setTimeout(later,wait),result=func.apply(context,args),context=args=null),result}};return{dom:dom,debounce:debounce}}]),ngQT.directive("quickTable",["$injector","$qtApi","$qtUtil","$rowSorter",function($injector,$qtApi,$qtUtil,$rowSorter){function linkFunc($scope,elm){var table,$table,$compile=$injector.get("$compile"),qtvm=$scope.qtvm;qtvm.render({id:$scope.id,tableDef:$scope.options,columnDef:$scope.columnDef,records:$scope.records,container:elm[0]}),qtvm.table.selectAllRow=$scope.selectAllRow,qtvm.compileTable=function(){elm.empty(),table=angular.element(qtvm.table.tpl),$table=$compile(table)($scope),elm.append($table)},qtvm.compileTable(),qtvm.ifMergeNeeded=qtvm.table.ifMergeNeeded=function(columnDef){var shouldBeMerged=[],headerExceed=$table[0].clientWidth>elm[0].clientWidth;if(headerExceed){for(var ii=0;ii<columnDef.length;ii++){var def=columnDef[ii];"combined"!=def.type&&"textarea"!=def.type&&"custom"!=def.type&&shouldBeMerged.push(def)}return qtvm.table.mergeColumn(shouldBeMerged)}for(var $headerCells=$table.find("th"),ii=columnDef.length-1;ii>=0;ii--){var def=columnDef[ii];def.width||$headerCells[ii]&&def.minWidth&&def.minWidth+20>$headerCells[ii].clientWidth&&"combined"!=def.type&&"textarea"!=def.type&&"custom"!=def.type&&shouldBeMerged.push(def)}return qtvm.table.mergeColumn(shouldBeMerged)},qtvm.mergeColumnRerender=function(newColumnDef){newColumnDef||(newColumnDef=qtvm.ifMergeNeeded(qtvm.table.columnDef)),qtvm.reRender(newColumnDef?{columnDef:newColumnDef}:{columnDef:$scope.columnDef})};var onWindowResize=$qtUtil.debounce(function(){qtvm.mergeColumnRerender(qtvm.ifMergeNeeded($scope.columnDef))},500);$scope.options.autoMergeColumn&&window.addEventListener("resize",onWindowResize),$scope.$on("$destroy",function(){window.removeEventListener("resize",onWindowResize)})}var events={rowSelect:"ROW_SELECT",rowUnselect:"ROW_UNSELECT",rowSelectAll:"ROW_SELECT_ALL",rowClear:"ROW_CLEAR"},directiveObj={restrict:"E",replace:!0,scope:{columnDef:"=",records:"=?",options:"=?",id:"@"},template:function(){return console.log("template"),'<div class="qt-table-wraper"></div>'},controller:["$scope",function($scope){var qtvm=this;this.sortMap={},this.render=function(opt,callback){return qtvm.table=$qtApi.create(opt),$scope.rowSelection=this.table.rowSelection={},qtvm.compileTable&&"function"==typeof qtvm.compileTable&&qtvm.compileTable(),qtvm.table.render=qtvm.render,"function"==typeof callback&&callback.call(null,qtvm.table),qtvm.table},this.reRender=function(opt){qtvm.table.reBuildTable(opt),qtvm.compileTable()},$scope.selectAllRow=function(selectOrUnselect){for(var ii=0;ii<$scope.records.length;ii++)$scope.rowSelection[$scope.records[ii]._id]=selectOrUnselect},$scope.$watch("allRowSelected",function(newVal,oldVal){newVal?($scope.selectAllRow(!0),$scope.$emit(events.rowSelectAll)):!newVal&&oldVal&&($scope.selectAllRow(!1),$scope.$emit(events.rowClear))}),this.sortRow=function(key){var oldWay=qtvm.sortMap[key];if(qtvm.sortMap={},qtvm.sortMap[key]="asc"==oldWay?"desc":"desc"==oldWay?null:"asc",qtvm.sortMap[key]){var sortFunc=$rowSorter.sort(key,$scope.records,qtvm.sortMap[key]);$scope.records.sort(sortFunc)}}}],controllerAs:"qtvm",link:linkFunc};return directiveObj}]),ngQT.factory("$qtApi",[function(){function Qtable(options){if(this.rawData=options.data||{def:[],records:[]},this.columnDef=options.columnDef,this.columnDef||(this.columnDef=this.rawToColumnDef(this.rawData)),this.container=options.container,this.id=options.id,options.tableDef||(options.tableDef={}),this.theme=options.tableDef.theme||"qt-theme-basic",this.striped=options.tableDef.striped,this.bordered=options.tableDef.bordered,this.enableHover=options.tableDef.enableHover,this.rows=[],this.records=options.records||[],this.generateIdMap(this.records),options.tableDef.autoMergeColumn)if(this.autoMergeColumn=!0,"function"==typeof this.ifMergeNeeded)this.ifMergeNeeded(this.columnDef);else{if(!this.container)throw new Error("autoMergeColumn need container");var coldefs=this.isHeaderRowTooNarrow(this.columnDef,this.container);this.mergeColumn(coldefs)}this.enableRowSelection=options.tableDef.rowSelection,this.enableRowSelection&&(this.rowSelection={},this.addRowSelectionColumn()),this.enableSort=options.tableDef.enableSort,this.enableSort,this.buildTable()}var _id=0,pro=Qtable.prototype;pro.rawToColumnDef=function(raw){if(!Array.isArray(raw))throw new TypeError("raw data shoud be an array");var def=[];return def},pro.generateIdMap=function(records){this.recordIdMap={};for(var i=records.length-1;i>=0;i--)records[i]._id||(records[i]._id=this.idGen("record")),this.recordIdMap[records[i]._id]=records[i];return this.records=records,this.recordIdMap},pro.buildTable=function(){this.columnDef.sort(function(a,b){return a.order-b.order}),this.tpl=this.buildTableTpl()},pro.reBuildTable=function(opt){for(var key in opt)opt.hasOwnProperty(key)&&(this[key]=opt[key]);return this.buildTable(),this.tpl},pro.buildTableTpl=function(){var styleClasses="";this.striped&&(styleClasses+=" qt-striped"),this.bordered&&(styleClasses+=" qt-bordered"),this.enableHover&&(styleClasses+=" qt-hover");for(var tpl='<table class="qt-table '+styleClasses+'" id="'+this.id+'" width="100%" >',tHeadHTML='<thead><tr class="qt-head-row">',rowTpl='<tr ng-repeat="record in records track by record._id" class="qt-row" ng-class="{active:rowSelection[record._id]}">',rowEditTpl={},colIndex=0;colIndex<this.columnDef.length;colIndex++){var colDef=this.columnDef[colIndex],cellTpl="",theader=colDef.headerTpl?colDef.headerTpl:colDef.key,theaderWidth='width="'+(colDef.width?colDef.width:"")+'px"',enableSort=this.enableSort?this.getSortStringForTpl(colDef):null;if(tHeadHTML+="<th "+theaderWidth+(enableSort?enableSort:"")+">"+theader+(enableSort?'<span class="qt-sort-arrow" ng-class="{up: qtvm.sortMap[\''+colDef.key+"']=='asc', down: qtvm.sortMap['"+colDef.key+"']=='desc' }\"><span>":"")+"</th>","combined"==colDef.type){if(!Array.isArray(colDef.fields))throw new TypeError('kye:"'+colDef.key+'" type="combined" must have fields property, and it must be array');cellTpl="<td "+this.getCellAttr(colDef.attr)+'class="qt-combined"><ul>';for(var ii=0;ii<colDef.fields.length;ii++)cellTpl+="<li>"+colDef.fields[ii].key+': {{record["'+colDef.fields[ii].key+'"]}}</li>';cellTpl+="</ul></td>",rowEditTpl[colDef.key]="还没有想好 怎么写"}else if("custom"==colDef.type){if(!colDef.tpl)throw new Error('if colDef.type == "custom" then this column def must have "tpl" property');cellTpl="<td "+this.getCellAttr(colDef.attr)+'class="qt-custom">'+colDef.tpl+"</td>",rowEditTpl[colDef.key]=null}else if("select"==colDef.type||"boolean"==colDef.type){if(cellTpl="<td "+this.getCellAttr(colDef.attr)+'class="qt-select">{{record["'+colDef.key+'"]}}</td>',!colDef.selectOption||!Array.isArray(colDef.selectOption.choices))throw new Error('if colDef.type=="slect" or "boolean" then thisl column def must have "selectOption" and "colDef.selectOption.choices" must be array');rowEditTpl[colDef.key]="<select>",colDef.selectOption.choices.forEach(function(choice){rowEditTpl[colDef.key]+='<option value="'+choice+'">'+choice+"</option>"}),rowEditTpl[colDef.key]+="</select>"}else"textarea"==colDef.type?(cellTpl="<td "+this.getCellAttr(colDef.attr)+'class="qt-textarea">{{record["'+colDef.key+'"]}}</td>',rowEditTpl[colDef.key]='<textarea type="text"></textarea>'):(cellTpl="<td "+this.getCellAttr(colDef.attr)+'class="qt-input">{{record["'+colDef.key+'"]}}</td>',rowEditTpl[colDef.key]='<input type="text" value="">');rowTpl+=cellTpl}return tHeadHTML+="</tr></thead>",rowTpl+="</tr>",tpl+=tHeadHTML,tpl+="<tbody>"+rowTpl+"</tbody>",tpl+="</table>"},pro.getCellAttr=function(attrObj){if(!attrObj)return"";var attrs="";for(var aa in attrObj)attrObj.hasOwnProperty(aa)&&(attrs+=" "+aa+'="'+attrObj[aa]+'"');return attrs},pro.addRowSelectionColumn=function(def){def||(def={});var rowdef={key:"rowSelect",order:0,type:"custom",width:def.width||50,headerTpl:def.headerTpl||'<div><input type="checkbox" ng-model="allRowSelected"/></div>',tpl:def.tpl||'<input type="checkbox" ng-model="rowSelection[record._id]"/>'};this.columnDef.unshift(rowdef)},pro.getSelectedRows=function(){this.rows=[];for(var _id in this.rowSelection)this.rowSelection[_id]&&this.rows.push(this.recordIdMap[_id]);return this.rows},pro.setSelectedRows=function(ids){if(!Array.isArray(ids))throw new TypeError("setSelectedRows(ids) only accept array of row id");return ids.forEach(function(_id){this.recordIdMap[_id]&&(this.rowSelection[_id]=!0)}),this.rowSelection},pro.isHeaderRowTooNarrow=function(columnDefs,container){var shouldBeMerged=[],avgWidth=container.clientWidth/columnDefs.length;if(columnDefs.sort(function(a,b){return a.key.length-b.key.length}),120>avgWidth)for(var ii=columnDefs.length-1;ii>=0;ii--)if(!(shouldBeMerged.length>=3)){var def=columnDefs[ii];"combined"==def.type||"custom"==def.type||"textarea"==def.type||def.width||shouldBeMerged.push(def)}return shouldBeMerged},pro.mergeColumn=function(columnDefs){if(!Array.isArray(columnDefs))throw new TypeError("mergeColumn(columnDefs) only accept array of columnDef ");if(!(columnDefs.length<=1)){columnDefs.sort(function(a,b){return a.order-b.order});for(var combinedDef={key:"合并显示",order:columnDefs[0].order,type:"combined",isGerated:!0,fields:[]},ii=columnDefs.length-1;ii>=0;ii--){var def=columnDefs[ii];combinedDef.fields.push(columnDefs[ii]),this.columnDef=this.columnDef.filter(function(ee){return ee.key!=def.key?ee:void 0})}return console.log("-----combinedDef"),console.log(combinedDef),this.columnDef.splice(combinedDef.order,0,combinedDef),this.columnDef}},pro.getSortStringForTpl=function(def){return-1!=["custom","combined","textarea"].indexOf(def.type)?null:" ng-click=\"qtvm.sortRow('"+def.key+'\')" class="qt-sort-enabled"'};var idGen=pro.idGen=function(prefix){return prefix+"_"+_id++},api={tables:{},create:function(options){var id=options.id||idGen("ngt");return options.id=id,this.tables[id]=new Qtable(options),this.tables[id]},getTable:function(id){return this.tables[id]}};return api}]),ngQT.factory("$rowSorter",function(){var rowSorter={};return rowSorter.guessSortFn=function(item){var itemType=typeof item;if("string"==itemType&&parseFloat(item,10)==item)return"sortNumberStr";switch(itemType){case"number":return"sortNumber";case"boolean":return"sortBool";case"string":return"sortAlpha";case"date":return"sortDate";case"object":return"basicSort";default:throw new Error("No sorting function found for type:"+itemType)}},rowSorter.handleNulls=function(a,b){if(!a&&0!==a&&a!==!1||!b&&0!==b&&b!==!1){if(!a&&0!==a&&a!==!1&&!b&&0!==b&&b!==!1)return 0;if(!a&&0!==a&&a!==!1)return 1;if(!b&&0!==b&&b!==!1)return-1}return null},rowSorter.basicSort=function(a,b){var nulls=rowSorter.handleNulls(a,b);return null!==nulls?nulls:a===b?0:b>a?-1:1},rowSorter.sortNumber=function(a,b){var nulls=rowSorter.handleNulls(a,b);return null!==nulls?nulls:a-b},rowSorter.sortNumberStr=function(a,b){var nulls=rowSorter.handleNulls(a,b);if(null!==nulls)return nulls;var numA,numB,badA=!1,badB=!1;return numA=parseFloat(a.replace(/[^0-9.-]/g,"")),isNaN(numA)&&(badA=!0),numB=parseFloat(b.replace(/[^0-9.-]/g,"")),isNaN(numB)&&(badB=!0),badA&&badB?0:badA?1:badB?-1:numA-numB},rowSorter.sortAlpha=function(a,b){var nulls=rowSorter.handleNulls(a,b);if(null!==nulls)return nulls;var strA=a.toLowerCase(),strB=b.toLowerCase();return strA===strB?0:strB>strA?-1:1},rowSorter.sortDate=function(a,b){var nulls=rowSorter.handleNulls(a,b);if(null!==nulls)return nulls;var timeA=a.getTime(),timeB=b.getTime();return timeA===timeB?0:timeB>timeA?-1:1},rowSorter.sortBool=function(a,b){var nulls=rowSorter.handleNulls(a,b);return null!==nulls?nulls:a&&b?0:a||b?a?1:-1:0},rowSorter.sort=function(key,rows,direction,method){function sortMethodWraper(a,b){var val=rowSorter[method](a[key],b[key]);return"desc"==direction?-1*val:val}if(!key||!rows||!direction)throw new Error("key, rows, direction is required for rowSorter.sort() ");if(!method||-1==["sortBool","sortNumber","sortNumberStr","sortAlpha","sortDate","basicSort"].indexOf(method)){for(var item,ii=0;!item&&ii<rows.length;)item=rows[ii][key],ii++;method=rowSorter.guessSortFn(item)}return sortMethodWraper},rowSorter});