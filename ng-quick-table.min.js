"use strict";var ngQT=angular.module("ngQuickTable",[]);ngQT.provider("ngQuickTableDefaults",function(){return{options:{dateFormat:"M/d/yyyy"},$get:function(){return this.options},set:function(e,t){var r,o,n;if("object"==typeof e){n=[];for(r in e)o=e[r],n.push(this.options[r]=o);return n}return this.options[e]=t}}}),ngQT.factory("$qtUtil",[function(){var e={};e.findParentScrolled=function(e){var t=e.parentNode;if(t.isEqualNode(document.body))return!1;var r=getComputedStyle(t);return e.scrollHeight>t.clientHeight&&("scroll"==r.overflow||"scroll"==r["overflow-y"]||"auto"==r.overflow||"auto"==r["overflow-y"])?t:findParentScrolled(t)};var t=function(e,t){var r,o,n,i,l,a;return l=r=o=a=i=null,n=function(){var e;return e=+new Date-a,l=t>e&&e>0?setTimeout(n,t-e):null},function(){return o=this,r=arguments,a=+new Date,l||(l=setTimeout(n,t),i=e.apply(o,r),o=r=null),i}};return{dom:e,debounce:t}}]),ngQT.directive("quickTable",["$injector","$qtApi","$qtUtil","$rowSorter",function(e,t,r,o){function n(t,o){function n(e){var r=e.target;if(a(),-1!=["LI","TD"].indexOf(r.tagName)){var o,n,i,l,d;"TD"==r.tagName?(n=r.dataset.columnkey,d=r.parentNode,o=d.dataset.rowidx,l=r):(i=r.dataset.idx,l=r.parentNode.parentNode,n=l.dataset.columnkey,d=r.parentNode.parentNode.parentNode,o=d.dataset.rowidx);var u=c.table.rowEditTpl[n];if(u){var f=c.table.defKeyMap[n];"combined"==f.type?f.fields.forEach(function(e){u=u.replace("__model_"+e.key,'ng-model="records['+o+"]['"+e.key+"']\"")}):u=u.replace("__model_"+n,'ng-model="records['+o+"]['"+n+"']\"");var p=angular.element("<td>"+u+"</td>"),h=s(p)(t);l.classList.add("hidden"),c.cellEditMap={targetCell:l,editCell:h,isEditing:!0,columnkey:n,rowidx:o,fieldIdx:i},angular.element(l).after(h)}}}function l(e){13==e.keyCode&&c.cellEditMap.isEditing&&a()}function a(){c.cellEditMap.isEditing&&(t.$emit(i.cellEdit,{columnkey:c.cellEditMap.columnkey,row:t.records[c.cellEditMap.rowidx]}),c.cellEditMap.targetCell.classList.remove("hidden"),c.cellEditMap.editCell.remove()),c.cellEditMap={}}var s=e.get("$compile"),c=t.qtvm;c.elements={container:o};var d,u;c.render({id:t.id,tableDef:t.options,columnDef:t.columnDef,records:t.records,container:o[0]},function(){t.$emit(i.initialRender,c)}),c.table.selectAllRow=t.selectAllRow,c.compileTable=function(){o.empty(),d=angular.element(c.table.tpl),u=s(d)(t),o.append(u)},c.compileTable(),c.elements.table=u,c.ifMergeNeeded=c.table.ifMergeNeeded=function(e){var t=[],r=u[0].clientWidth>o[0].clientWidth;if(r){for(var n=0;n<e.length;n++){var i=e[n];"combined"!=i.type&&"textarea"!=i.type&&"custom"!=i.type&&t.push(i)}return c.table.mergeColumn(t)}for(var l=u.find("th"),n=e.length-1;n>=0;n--){var i=e[n];i.width||l[n]&&i.minWidth&&i.minWidth+20>l[n].clientWidth&&"combined"!=i.type&&"textarea"!=i.type&&"custom"!=i.type&&t.push(i)}return c.table.mergeColumn(t)},c.mergeColumnRerender=function(e){e||(e=c.ifMergeNeeded(c.table.columnDef)),c.reRender(e?{columnDef:e}:{columnDef:t.columnDef})};var f=r.debounce(function(){c.mergeColumnRerender(c.ifMergeNeeded(t.columnDef))},500);c.rowFilter={},c.showFilter=t.options.showFilter,c.clearFilter=function(e){delete c.rowFilter[e]},c.cellEditMap={},u.on("dblclick",n),angular.element(document).on("keypress",l),t.options.autoMergeColumn&&window.addEventListener("resize",f),t.$on("$destroy",function(){window.removeEventListener("resize",f),u.off("dblclick",n),angular.element(document).off("keypress",l)})}var i={initialRender:"INITIAL_RENDER",rowSelect:"ROW_SELECT",rowUnselect:"ROW_UNSELECT",rowSelectAll:"ROW_SELECT_ALL",rowClear:"ROW_CLEAR",cellEdit:"CELL_EDIT"},l={restrict:"E",replace:!0,scope:{columnDef:"=",records:"=?",options:"=?",id:"@"},template:function(){return console.log("template"),'<div class="qt-table-wraper"></div>'},controller:["$scope",function(e){var r=this;this.sortMap={},this.render=function(o,n){return r.table=t.create(o),e.rowSelection=this.table.rowSelection={},r.compileTable&&"function"==typeof r.compileTable&&r.compileTable(),r.table.render=r.render,"function"==typeof n&&n.call(null,r.table),r.table},this.reRender=function(e){r.table.reBuildTable(e),r.compileTable()},e.selectAllRow=function(t){for(var r=0;r<e.records.length;r++)e.rowSelection[e.records[r]._id]=t},e.$watch("allRowSelected",function(t,r){t?(e.selectAllRow(!0),e.$emit(i.rowSelectAll)):!t&&r&&(e.selectAllRow(!1),e.$emit(i.rowClear))}),this.sortRow=function(t){var n=r.sortMap[t];if(r.sortMap={},r.sortMap[t]="asc"==n?"desc":"desc"==n?null:"asc",r.sortMap[t]){var i=o.sort(t,e.records,r.sortMap[t]);e.records.sort(i)}}}],controllerAs:"qtvm",link:n};return l}]),ngQT.factory("$tableExporter",function(){var e={};return e.link='<a href="data:text/csv;charset=UTF-8,CSV_CONTENT">LINK_LABEL</a>',e.formatAsCsv=function(e,t,r){var o=this;r=r||",";var n=e.map(function(e){return e.key}),i=o.formatRowAsCsv(this,r)(n)+"\n";return i+=t.map(this.formatRowAsCsv(this,r,e)).join("\n")},e.formatRowAsCsv=function(t,r,o){return function(n){if(Array.isArray(n))return n.map(t.formatFieldAsCsv).join(r);if("object"!=typeof n)return"";var i=[];if(!o)throw new Error("if you want to parse a row which is array of object, you need to pass in the columnDef so we can decide the order of each field");return o.forEach(function(t){i.push(e.formatFieldAsCsv(n[t.key]))}),i}},e.formatFieldAsCsv=function(e){return null==e?'" "':"number"==typeof e?e:"boolean"==typeof e?e?"TRUE":"FALSE":"string"==typeof e?'"'+e.replace(/"/g,'""')+'"':JSON.stringify(e)},e.generateLink=function(e,t,r){var o=this.formatAsCsv(e,t,r);return console.log(o),this.link.replace("CSV_CONTENT",encodeURIComponent(o))},e}),ngQT.factory("$qtApi",["$tableExporter",function(e){function t(e){if(this.rawData=e.data||{def:[],records:[]},this.columnDef=e.columnDef,this.columnDef||(this.columnDef=this.rawToColumnDef(this.rawData)),this.container=e.container,this.id=e.id,e.tableDef||(e.tableDef={}),this.theme=e.tableDef.theme||"qt-theme-basic",this.striped=e.tableDef.striped,this.bordered=e.tableDef.bordered,this.enableHover=e.tableDef.enableHover,this.exportOptions={csvExportLinkLable:e.csvExportLinkLable||"下载CSV",csvFileName:e.csvFileName||"导出的表格"},this.rows=[],this.records=e.records||[],this.recordIdMap=this.generateIdMap(this.records,"_id"),this.defKeyMap=this.generateIdMap(this.columnDef,"key"),e.tableDef.autoMergeColumn)if(this.autoMergeColumn=!0,"function"==typeof this.ifMergeNeeded)this.ifMergeNeeded(this.columnDef);else{if(!this.container)throw new Error("autoMergeColumn need container");var t=this.isHeaderRowTooNarrow(this.columnDef,this.container);this.mergeColumn(t)}this.enableRowSelection=e.tableDef.rowSelection,this.enableRowSelection&&(this.rowSelection={},this.addRowSelectionColumn()),this.enableSort=e.tableDef.enableSort,this.enableSort,this.buildTable()}var r=0,o=t.prototype;o.rawToColumnDef=function(e){if(!Array.isArray(e))throw new TypeError("raw data shoud be an array");var t=[];return t},o.generateIdMap=function(e,t){var r={};t||(t="_id");for(var o=e.length-1;o>=0;o--)e[o][t]||(e[o][t]=this.idGen("record")),r[e[o][t]]=e[o];return r},o.buildTable=function(){this.columnDef.sort(function(e,t){return e.order-t.order}),this.tpl=this.buildTableTpl()},o.reBuildTable=function(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);return this.buildTable(),this.tpl},o.buildTableTpl=function(){var e="";this.striped&&(e+=" qt-striped"),this.bordered&&(e+=" qt-bordered"),this.enableHover&&(e+=" qt-hover");for(var t='<table class="qt-table '+e+'" id="'+this.id+'" width="100%" >',r='<thead><tr class="qt-head-row">',o='<tr ng-repeat="record in records | filter:qtvm.rowFilter track by record._id" data-rowidx={{$index}} class="qt-row" ng-class="{active:rowSelection[record._id]}">',n={},i=0;i<this.columnDef.length;i++){var l=this.columnDef[i],a="",s='width="'+(l.width?l.width:"")+'px"',c=this.enableSort?this.getSortStringForTpl(l):null,d=l.headerTpl?l.headerTpl:"<div "+(c?c:"")+">"+l.key;if(d+=c?'<span class="qt-sort-arrow" ng-class="{up: qtvm.sortMap[\''+l.key+"']=='asc', down: qtvm.sortMap['"+l.key+"']=='desc' }\"><span>":"",d+="</div>",r+="<th "+s+">"+d,r+=["combined","custom"].indexOf(l.type)<0?'<div ng-if="qtvm.showFilter" class="qt-row-filter clearfix"> 					<input ng-model="qtvm.rowFilter[\''+l.key+"']\" ng-model-options=\"{ updateOn: 'default blur', debounce: {'default': 500, 'blur': 0} }\" type=\"text\"> 					<span class=\"qt-clear-filter\" ng-click=\"qtvm.clearFilter('"+l.key+"')\" ng-show=\"qtvm.rowFilter['"+l.key+"']\">✕</span></div>":'<div ng-if="qtvm.showFilter" class="qt-row-filter clearfix"></div>',r+="</th>","combined"==l.type){if(!Array.isArray(l.fields))throw new TypeError('kye:"'+l.key+'" type="combined" must have fields property, and it must be array');var u=this.getCombinedColTpl(l);a=u.cellTpl,a+="</ul></td>",n[l.key]=u.editTpl}else if("custom"==l.type){if(!l.tpl)throw new Error('if colDef.type == "custom" then this column def must have "tpl" property');a="<td "+this.getCellAttr(l)+'class="qt-custom">'+l.tpl+"</td>",n[l.key]=null}else if("select"==l.type||"boolean"==l.type){if(a="<td "+this.getCellAttr(l)+'class="qt-select">{{record["'+l.key+'"]}}</td>',!l.selectOption||!Array.isArray(l.selectOption.choices))throw new Error('if colDef.type=="slect" or "boolean" then thisl column def must have "selectOption" and "colDef.selectOption.choices" must be array');n[l.key]="<select __model_"+l.key+">",l.selectOption.choices.forEach(function(e){n[l.key]+='<option value="'+e+'">'+e+"</option>"}),n[l.key]+="</select>"}else"textarea"==l.type?(a="<td "+this.getCellAttr(l)+'class="qt-textarea">{{record["'+l.key+'"]}}</td>',n[l.key]='<textarea type="text" __model_'+l.key+"></textarea>"):(a="<td "+this.getCellAttr(l)+'class="qt-input">{{record["'+l.key+'"]}}</td>',n[l.key]='<input type="text" value="" __model_'+l.key+">");o+=a}return this.rowEditTpl=n,r+="</tr></thead>",o+="</tr>",t+=r,t+="<tbody>"+o+"</tbody>",t+="</table>"},o.getCellAttr=function(e){var t='data-columnkey="'+e.key+'"';if(!e.attr)return t;for(var r in e.attr)e.attr.hasOwnProperty(r)&&(t+=" "+r+'="'+e.attr[r]+'"');return t},o.getCombinedColTpl=function(e){for(var t="<td "+this.getCellAttr(e)+'class="qt-combined"><ul>',r="",o=0;o<e.fields.length;o++){var n=e.fields[o];t+='<li data-idx="'+o+'">'+n.key+': {{record["'+n.key+'"]}}</li>',"select"==n.type||"boolean"==n.type?(r+="<select __model_"+n.key+"__>",n.selectOption.choices.forEach(function(e){r=0/0+e+'">'+e+"</option>"})):r+="textarea"==n.type?"<textarea __model_"+n.key+"></textarea>":'<input type="text" __model_'+n.key+"/>"}return{cellTpl:t,editTpl:r}},o.addRowSelectionColumn=function(e){e||(e={});var t={key:"rowSelect",order:-3,type:"custom",width:e.width||50,headerTpl:e.headerTpl||'<div><input type="checkbox" ng-model="allRowSelected"/></div>',tpl:e.tpl||'<input type="checkbox" ng-model="rowSelection[record._id]"/>'};this.columnDef.unshift(t)},o.getSelectedRows=function(){this.rows=[];for(var e in this.rowSelection)this.rowSelection[e]&&this.rows.push(this.recordIdMap[e]);return this.rows},o.setSelectedRows=function(e){if(!Array.isArray(e))throw new TypeError("setSelectedRows(ids) only accept array of row id");return e.forEach(function(e){this.recordIdMap[e]&&(this.rowSelection[e]=!0)}),this.rowSelection},o.isHeaderRowTooNarrow=function(e,t){var r=[],o=t.clientWidth/e.length;if(e.sort(function(e,t){return e.key.length-t.key.length}),120>o)for(var n=e.length-1;n>=0;n--)if(!(r.length>=3)){var i=e[n];"combined"==i.type||"custom"==i.type||"textarea"==i.type||i.width||r.push(i)}return r},o.mergeColumn=function(e){if(!Array.isArray(e))throw new TypeError("mergeColumn(columnDefs) only accept array of columnDef ");if(!(e.length<=1)){e.sort(function(e,t){return e.order-t.order});for(var t={key:"合并显示",order:e[0].order,type:"combined",isGerated:!0,fields:[]},r=e.length-1;r>=0;r--){var o=e[r];t.fields.push(e[r]),this.columnDef=this.columnDef.filter(function(e){return e.key!=o.key?e:void 0})}return console.log("-----combinedDef"),console.log(t),this.columnDef.splice(t.order,0,t),this.columnDef}},o.getSortStringForTpl=function(e){return-1!=["custom","combined","textarea"].indexOf(e.type)?null:" ng-click=\"qtvm.sortRow('"+e.key+'\')" class="qt-sort-enabled qt-col-key"'},o.exportCsv=function(){for(var t=[],r=[],o=0;o<this.columnDef.length;o++){var n=this.columnDef[o];"combined"==n.type?n.fields.forEach(function(e){r.push(e),t.push(e)}):-1!=["input","textarea","boolean","select"].indexOf(n.type)&&t.push(n)}t.sort(function(e,t){return e.order-t.order});var i=e.generateLink(t,this.records).replace("LINK_LABEL",this.exportOptions.csvExportLinkLable);return i};var n=o.idGen=function(e){return e+"_"+r++},i={tables:{},create:function(e){var r=e.id||n("ngt");return e.id=r,this.tables[r]=new t(e),this.tables[r]},getTable:function(e){return this.tables[e]}};return i}]),ngQT.factory("$rowSorter",function(){var e={};return e.guessSortFn=function(e){var t=typeof e;if("string"==t&&parseFloat(e,10)==e)return"sortNumberStr";switch(t){case"number":return"sortNumber";case"boolean":return"sortBool";case"string":return"sortAlpha";case"date":return"sortDate";case"object":return"basicSort";default:throw new Error("No sorting function found for type:"+t)}},e.handleNulls=function(e,t){if(!e&&0!==e&&e!==!1||!t&&0!==t&&t!==!1){if(!e&&0!==e&&e!==!1&&!t&&0!==t&&t!==!1)return 0;if(!e&&0!==e&&e!==!1)return 1;if(!t&&0!==t&&t!==!1)return-1}return null},e.basicSort=function(t,r){var o=e.handleNulls(t,r);return null!==o?o:t===r?0:r>t?-1:1},e.sortNumber=function(t,r){var o=e.handleNulls(t,r);return null!==o?o:t-r},e.sortNumberStr=function(t,r){var o=e.handleNulls(t,r);if(null!==o)return o;var n,i,l=!1,a=!1;return n=parseFloat(t.replace(/[^0-9.-]/g,"")),isNaN(n)&&(l=!0),i=parseFloat(r.replace(/[^0-9.-]/g,"")),isNaN(i)&&(a=!0),l&&a?0:l?1:a?-1:n-i},e.sortAlpha=function(t,r){var o=e.handleNulls(t,r);if(null!==o)return o;var n=t.toLowerCase(),i=r.toLowerCase();return n===i?0:i>n?-1:1},e.sortDate=function(t,r){var o=e.handleNulls(t,r);if(null!==o)return o;var n=t.getTime(),i=r.getTime();return n===i?0:i>n?-1:1},e.sortBool=function(t,r){var o=e.handleNulls(t,r);return null!==o?o:t&&r?0:t||r?t?1:-1:0},e.sort=function(t,r,o,n){function i(r,i){var l=e[n](r[t],i[t]);return"desc"==o?-1*l:l}if(!t||!r||!o)throw new Error("key, rows, direction is required for rowSorter.sort() ");if(!n||-1==["sortBool","sortNumber","sortNumberStr","sortAlpha","sortDate","basicSort"].indexOf(n)){for(var l,a=0;!l&&a<r.length;)l=r[a][t],a++;n=e.guessSortFn(l)}return i},e});